<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Donazione libri Biblioteca Elsa Morante di Ostia Municipio Roma X">
    <title>Modulo donazione</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <script type="module" src="scripts/config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #970a2c;
            --secondary: #540f26;
            --accent: #700f0a;
        }

        body {
            font-family: 'Space Grotesk', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            line-height: 1.6;
            color: #334155;
        }

        /* Utility classes - sostituiscono Tailwind */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .hidden {
            display: none !important;
        }

        .flex {
            display: flex;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .justify-center {
            justify-content: center;
        }

        .gap-1 { gap: 0.25rem; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }

        .w-full {
            width: 100%;
        }

        .max-w-4xl {
            max-width: 56rem;
        }

        .mx-auto {
            margin-left: auto;
            margin-right: auto;
        }

        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-5 { margin-bottom: 1.25rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-10 { margin-bottom: 2.5rem; }
        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-3 { margin-top: 0.75rem; }
        .mt-16 { margin-top: 4rem; }

        .p-3 { padding: 0.75rem; }
        .p-4 { padding: 1rem; }
        .p-5 { padding: 1.25rem; }
        .p-6 { padding: 1.5rem; }
        .p-8 { padding: 2rem; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
        .py-8 { padding-top: 2rem; padding-bottom: 2rem; }

        .text-sm { font-size: 0.875rem; }
        .text-base { font-size: 1rem; }
        .text-lg { font-size: 1.125rem; }
        .text-3xl { font-size: 1.875rem; }

        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }

        .text-white { color: white; }
        .text-gray-500 { color: #6b7280; }
        .text-gray-600 { color: #4b5563; }
        .text-gray-700 { color: #374151; }
        .text-red-500 { color: #ef4444; }
        .text-blue-500 { color: #3b82f6; }
        .text-blue-600 { color: #2563eb; }
        .text-green-500 { color: #22c55e; }
        .text-slate-700 { color: #334155; }

        .bg-white { background-color: white; }
        .bg-gray-50 { background-color: #f9fafb; }
        .bg-blue-50 { background-color: #eff6ff; }

        .border { border: 1px solid #e5e7eb; }
        .border-2 { border: 2px solid; }
        .border-gray-200 { border-color: #e5e7eb; }
        .border-gray-300 { border-color: #d1d5db; }
        .border-blue-500 { border-color: #3b82f6; }
        .border-red-500 { border-color: #ef4444; }
        .border-l-4 { border-left: 4px solid; }

        .rounded { border-radius: 0.25rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-r { border-radius: 0 0.25rem 0.25rem 0; }
        .rounded-l { border-radius: 0.25rem 0 0 0.25rem; }
        .rounded-full { border-radius: 9999px; }

        .block {
            display: block;
        }

        .relative {
            position: relative;
        }

        .fixed {
            position: fixed;
        }

        .inset-0 {
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
        }

        .top-4 {
            top: 1rem;
        }

        .z-50 {
            z-index: 50;
        }

        .transform {
            transform: translate(var(--tw-translate-x), var(--tw-translate-y));
        }

        .-translate-x-1\/2 {
            --tw-translate-x: -50%;
        }

        .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* Form inputs */
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="number"],
        textarea,
        select {
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        input[type="number"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #0078d7;
            box-shadow: 0 0 0 2px rgba(0, 120, 215, 0.1);
        }

        input:disabled,
        textarea:disabled,
        select:disabled {
            background-color: #f3f4f6;
            cursor: not-allowed;
        }

        .location-icon {
            transition: all 0.3s ease;
            filter: invert(9%) sepia(38%) saturate(6611%) hue-rotate(345deg) brightness(63%) contrast(99%);
        }

        .location-icon:hover {
            filter: invert(21%) sepia(99%) saturate(7402%) hue-rotate(356deg) brightness(141%) contrast(124%);
            transform: scale(1.1);
        }

        .required-asterisk {
            color: #970a2c;
            font-size: 1.25em;
            display: inline-block;
            margin-left: 4px;
            vertical-align: middle;
        }

        .section-header {
            font-size: 1.5rem;
            font-weight: 600;
            color: #970a2c;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #970a2c;
        }

        .book-entry {
            border-radius: 0.75rem;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .book-entry:hover {
            transform: translateY(-2px);
        }

        .book-counter {
            background: linear-gradient(to bottom right, #34d399, #10b981);
            width: 1.5rem;
            height: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
        }

        button[type="submit"] {
            background-color: #0078d7;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            max-width: 32rem;
            margin: 0 auto;
            display: block;
        }

        button[type="submit"]:hover {
            background-color: #005a9e;
        }

        .add-book-btn {
            width: 100%;
            padding: 0.75rem 1rem;
            background: linear-gradient(to bottom right, #34d399, #10b981);
            color: white;
            border: none;
            border-radius: 0.375rem;
            transition: all 0.3s ease;
            margin-top: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
        }

        .add-book-btn:hover {
            transform: translateY(-2px);
            background: linear-gradient(to bottom right, #10b981, #059669);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        .top-banner {
            background-color: white;
            padding: 0.8rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .roma-logo {
            height: 40px;
        }

        .social-icons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            align-items: center;
        }

        .social-icons a {
            color: var(--primary);
            font-size: 1.5rem;
            transition: transform 0.3s ease;
        }

        .social-icons a:hover {
            transform: scale(1.2);
        }

        header {
            background-color: var(--primary);
            color: #fff;
            padding: 2rem 0;
            min-height: 4cm;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            flex-direction: column;
            text-align: center;
        }

        .container-header {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .content-wrapper {
            max-width: 900px;
            width: 100%;
            margin: 2rem auto;
            padding: 0 1rem;
            position: relative;
            margin-top: 60px;
        }

        .nav-icons {
            position: absolute;
            top: -60px;
            left: 50%;
            transform: translateX(calc(-50% - 400px));
            display: flex;
            align-items: center;
            gap: 3rem;
            padding-top: 20px;
        }

        .nav-icons a {
            color: #970a2c;
            font-size: 1.25rem;
            text-decoration: none;
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            height: 100%;
            padding: 5px;
        }

        .nav-icons a:hover {
            transform: scale(1.1);
        }

        header img {
            height: 70px;
            max-width: 100%;
        }

        header .logo-morante {
            height: 180px;
            filter: none;
            max-width: 100%;
        }

        footer {
            background-color: #970a2c;
            color: white;
            margin-top: 4rem;
            padding: 2rem 0;
            box-shadow: 0 -2px 4px -1px rgba(0, 0, 0, 0.1);
        }

        input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #000;
            border-radius: 0.25rem;
            margin-right: 0.5rem;
            display: grid;
            place-content: center;
        }

        input[type="checkbox"]:checked {
            background-color: #0078d7;
            border-color: #0078d7;
        }

        input[type="checkbox"]:checked::before {
            content: "";
            width: 0.65em;
            height: 0.65em;
            transform: scale(1);
            background-color: white;
            transform-origin: bottom left;
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }

        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
        }

        .error-popup {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            background-color: #ef4444;
            color: white;
            z-index: 50;
            animation: slideDown 0.5s ease-out;
        }

        .success-popup {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            background-color: #22c55e;
            color: white;
            z-index: 50;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .biblioteca-link {
            color: #970a2c;
            transition: color 0.3s;
            text-decoration: none;
        }

        .biblioteca-link:hover {
            color: #e06b8e;
        }

        .group:hover .group-hover-visible {
            visibility: visible;
            opacity: 1;
            background-color: white;
            color: black;
            border: 1px solid #ddd;
            white-space: nowrap;
            width: max-content;
            padding: 3px 8px;
            font-size: 12px;
            font-style: italic;
            font-family: inherit;
            box-shadow: none;
            border-radius: 5px;
        }

        .tooltip {
            position: absolute;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            max-width: 300px;
            white-space: normal;
            line-height: 1.4;
            pointer-events: none;
        }

        .search-result {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #e5e7eb;
            transition: background-color 0.15s;
        }

        .search-result:hover,
        .search-result.bg-gray-100 {
            background-color: #f3f4f6;
        }

        .search-result:last-child {
            border-bottom: none;
        }

        .isbn-scanner-modal {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .isbn-scanner-reader {
            border-radius: 0.5rem;
            overflow: hidden;
            position: relative;
            min-height: 300px;
            background: #000;
        }

        .isbn-scanner-reader video {
            width: 100%;
            height: auto;
            border-radius: 0.5rem;
        }

        .isbn-scanner-reader canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        @media (max-width: 768px) {
            .text-3xl {
                font-size: 1.5rem;
            }

            header {
                height: 130px;
            }

            .container-header img[src="logomorante.png"] {
                display: none;
            }

            .container-header img[src="logobianco.png"] {
                height: 35px;
            }

            .top-banner {
                padding: 0.4rem 1rem;
                min-height: 40px;
            }

            .nav-icons {
                position: relative;
                left: 0;
                top: 0;
                transform: none;
                justify-content: flex-start;
                padding: 0.75rem 1rem;
                margin-bottom: -0.5rem;
            }

            .content-wrapper {
                margin-top: -0.25rem;
            }

            footer .container {
                text-align: center;
            }
        }

        @media (max-width: 1400px) {
            .nav-icons {
                transform: translateX(calc(-50% - 300px));
            }
        }

        @media (max-width: 1200px) {
            .nav-icons {
                transform: translateX(calc(-50% - 200px));
            }
        }

        @media (max-width: 992px) {
            .nav-icons {
                transform: translateX(calc(-50% - 100px));
            }
        }
    </style>

    <script>
        const emailValidator = {
            validateSyntax(email) {
                const emailRegex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
                return emailRegex.test(email);
            }
        };

        function showError(input, message) {
            const errorElement = input.parentElement.querySelector('.error-message');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.classList.remove('hidden');
                input.classList.add('border-red-500');
                input.classList.remove('border-gray-300');
            }
        }

        function hideError(input) {
            const errorElement = input.parentElement.querySelector('.error-message');
            if (errorElement) {
                errorElement.classList.add('hidden');
                input.classList.remove('border-red-500');
                input.classList.add('border-gray-300');
            }
        }
    </script>
</head>

<body>
    <div class="top-banner">
        <a href="https://culture.roma.it/" target="_blank" title="Questo link si apre in una nuova finestra">
            <img src="roma.png" alt="Logo Roma" class="roma-logo">
        </a>
        <div class="social-icons">
            <a href="https://www.bibliotechediroma.it/opac" target="_blank" title="Cerca nel catalogo delle biblioteche di Roma">
                <img src="search.svg" alt="Cerca" style="height: 26px; width: 26px;">
            </a>
            <a href="https://www.facebook.com/biblioteca.elsamorante?locale=it_IT" target="_blank" title="Questo link si apre in una nuova finestra">
                <i class="fab fa-facebook"></i>
            </a>
            <a href="https://www.instagram.com/bibliotecaelsamorante/" target="_blank" title="Questo link si apre in una nuova finestra">
                <i class="fab fa-instagram"></i>
            </a>
            <a href="https://x.com/bibliomorante" target="_blank" title="Questo link si apre in una nuova finestra">
                <i class="fab fa-x-twitter"></i>
            </a>
            <a href="https://www.youtube.com/@bibliotecaelsamorante1172/featured" target="_blank" title="Questo link si apre in una nuova finestra">
                <i class="fab fa-youtube"></i>
            </a>
        </div>
    </div>

    <header>
        <div class="container-header">
            <a href="https://www.bibliotechediroma.it/opac/.do">
                <img src="logobianco.png" alt="Logo Biblioteche di Roma" style="height: 70px; max-width: 100%;">
            </a>
            <a href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Elsa%20Morante/RMBO2">
                <img src="logomorante.png" alt="Logo Biblioteca Morante" style="height: 180px; max-width: 100%;">
            </a>
        </div>
    </header>

    <div class="content-wrapper">
        <div class="nav-icons">
            <a href="https://www.bibliotechediroma.it/opac/news/donazioni/33158" title="Indietro">
                <img src="left.svg" alt="Indietro" style="height: 22px; width: 22px;">
            </a>
            <a href="https://www.bibliotechediroma.it/opac/.do" title="Home">
                <img src="home.svg" alt="Home" style="height: 22px; width: 22px;">
            </a>
        </div>

        <div class="max-w-4xl mx-auto bg-white p-8 rounded-lg mt-2">
            <div class="flex-col mb-10 text-left px-4" style="display: flex; gap: 1rem;">
                <div class="flex items-center gap-2 mb-2">
                    <a href="https://bibliotecamorante.github.io/mappa/" target="_blank" title="Visualizza la posizione sulla mappa">
                        <img alt="Posizione" src="location.svg" class="location-icon" style="height: 20px; width: 20px;">
                    </a>
                    <a href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Elsa%20Morante/RMBO2" target="_blank" class="biblioteca-link" title="Clicca qui per vedere gli appuntamenti della biblioteca">
                        Biblioteca Elsa Morante
                    </a>
                </div>
                <h1 class="text-3xl text-slate-700 font-bold" style="line-height: 1.2;">
                    Donazione di libri
                </h1>
            </div>
        </div>

        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded-r">
            Compila il modulo per donare i tuoi libri alla biblioteca. I campi contrassegnati con <span class="required-asterisk">*</span> sono obbligatori. È raccomandato compilare anche il campo ISBN per garantire una più accurata identificazione dei volumi.
        </div>

        <form id="donationForm" novalidate>
            <div id="error-root"></div>

            <h3 class="section-header">Dati Personali</h3>

            <div class="mb-5">
                <label for="nome" class="block mb-1 text-slate-700 font-medium">Nome<span class="required-asterisk">*</span></label>
                <input type="text" id="nome" name="nome" required class="w-full px-3 py-2 border-2 border-gray-300 rounded text-base">
                <p class="hidden error-message text-sm text-red-500 mt-1">Il nome è obbligatorio</p>
            </div>

            <div class="mb-5">
                <label for="cognome" class="block mb-1 text-slate-700 font-medium">Cognome<span class="required-asterisk">*</span></label>
                <input type="text" id="cognome" name="cognome" required class="w-full px-3 py-2 border-2 border-gray-300 rounded text-base">
                <p class="hidden error-message text-sm text-red-500 mt-1">Il cognome è obbligatorio</p>
            </div>

            <div class="mb-5">
                <label for="tessera" class="block mb-1 text-slate-700 font-medium">Numero Tessera</label>
                <input type="text" id="tessera" name="tessera" class="w-full px-3 py-2 border-2 border-gray-300 rounded text-base">
            </div>

            <div class="mb-5">
                <label for="telefono" class="block mb-1 text-slate-700 font-medium">Telefono</label>
                <input type="tel" id="telefono" name="telefono" class="w-full px-3 py-2 border-2 border-gray-300 rounded text-base">
                <p class="hidden error-message text-sm text-red-500 mt-1">Il numero di telefono deve contenere solo numeri (da 6 a 15 cifre)</p>
            </div>

            <div class="mb-5">
                <label for="email" class="block mb-1 text-slate-700 font-medium">Email<span class="required-asterisk">*</span></label>
                <input type="email" id="email" name="email" required class="w-full px-3 py-2 border-2 border-gray-300 rounded text-base">
                <p class="hidden error-message text-sm text-red-500 mt-1">Inserire un indirizzo email valido</p>
            </div>

            <h3 class="section-header">Libri da donare</h3>

            <div id="bookList"></div>

            <div class="mb-5 bg-gray-50 p-4 rounded">
                <div class="flex justify-between items-center mb-1">
                    <label for="notes" class="block text-slate-700 font-medium text-sm">Note aggiuntive</label>
                    <span id="charCount" class="text-sm text-gray-500">500 caratteri rimanenti</span>
                </div>
                <textarea id="notes" name="notes" rows="3" maxlength="500" class="w-full px-3 py-2 border-2 border-gray-300 rounded text-base bg-white" style="resize: vertical; min-height: 75px;" placeholder="Aggiungi eventuali note o commenti sulla donazione..."></textarea>
            </div>

            <div class="bg-gray-50 p-4 rounded mb-5">
                <label class="flex items-start gap-3" style="cursor: pointer;">
                    <input type="checkbox" id="accept" name="accept" required style="margin-top: 4px;">
                    <span>Ho letto e accetto <a href="termini.html" target="_blank" class="text-blue-500" style="text-decoration: underline;">termini e condizioni</a></span>
                </label>
                <p class="hidden error-message text-sm text-red-500 mt-1">Devi accettare i termini e le condizioni</p>
            </div>

            <button type="submit" class="w-full">
                Invia Donazione
            </button>
        </form>
    </div>

    <footer>
        <div class="container" style="display: flex; flex-direction: column; align-items: center; justify-content: space-between; gap: 1rem;">
            <div class="mb-4">
                <img src="footermorante.png" alt="Logo Biblioteca Morante" style="height: 2.5rem; cursor: pointer;" onclick="window.open('https://www.bibliotechediroma.it/opac/library/Biblioteca%20Elsa%20Morante/RMBO2', '_blank');">
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 2rem; justify-content: center; font-size: 0.875rem;">
                <div class="flex items-center gap-2">
                    <a href="https://bibliotecamorante.github.io/mappa/" target="_blank" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-location-dot" style="width: 1rem;"></i>
                        <span style="display: flex; flex-direction: column;">
                            <span>Porto turistico di Roma</span>
                            <span>Municipio X, 00121 Roma</span>
                        </span>
                    </a>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-phone" style="width: 1rem;"></i>
                        <span>
                            <a href="tel:+390645460481" style="text-decoration: none; color: inherit;">06 4546 0481</a>
                            /
                            <a href="tel:+390645460483" style="text-decoration: none; color: inherit;">0483</a>
                        </span>
                    </div>
                    <div class="flex items-center gap-2">
                        <i class="fas fa-clock" style="width: 1rem;"></i>
                        <span style="display: flex; flex-direction: column;">
                            <span>Lunedì-Venerdì 09:00-18:30</span>
                            <span>Sabato 09:00-13:00</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <script type="module">
        import config from './scripts/config.js';

        // Initialize EmailJS
        (function() {
            emailjs.init(config.emailjs.publicKey);
        })();

        let bookCount = 0;

        function showGlobalErrorPopup(message) {
            const existingPopups = document.querySelectorAll('.error-popup');
            existingPopups.forEach(popup => document.body.removeChild(popup));

            const popup = document.createElement('div');
            popup.className = 'error-popup';
            popup.innerHTML = message;

            setTimeout(() => {
                if (document.body.contains(popup)) {
                    document.body.removeChild(popup);
                }
            }, 5000);

            document.body.appendChild(popup);
        }

        function showSuccessPopup(message) {
            const existingPopups = document.querySelectorAll('.success-popup');
            existingPopups.forEach(popup => document.body.removeChild(popup));

            const popup = document.createElement('div');
            popup.className = 'success-popup';
            popup.innerHTML = message;

            setTimeout(() => {
                if (document.body.contains(popup)) {
                    document.body.removeChild(popup);
                }
            }, 5000);

            document.body.appendChild(popup);
        }

        function showLoadingOverlay() {
            const overlay = document.createElement('div');
            overlay.id = 'loadingOverlay';
            overlay.style.cssText = 'position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 50;';
            
            const spinner = document.createElement('div');
            spinner.style.cssText = 'background-color: white; padding: 1.25rem; border-radius: 0.5rem; display: flex; flex-direction: column; align-items: center;';
            spinner.innerHTML = `
                <div style="width: 2.5rem; height: 2.5rem; border: 2px solid #3b82f6; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 0.75rem;"></div>
                <div style="color: #334155; font-weight: 500;">Invio donazione in corso...</div>
            `;
            
            overlay.appendChild(spinner);
            document.body.appendChild(overlay);

            // Add keyframes for spinner animation
            if (!document.getElementById('spinnerKeyframes')) {
                const style = document.createElement('style');
                style.id = 'spinnerKeyframes';
                style.textContent = '@keyframes spin { to { transform: rotate(360deg); } }';
                document.head.appendChild(style);
            }
        }

        function removeLoadingOverlay() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        function validateField(input, showErrors = true) {
            const value = input.value.trim();
            let isValid = true;

            if (input.matches(':focus')) {
                hideError(input);
                return true;
            }

            if (input.hasAttribute('required') && !value && input.id !== 'email') {
                if (showErrors) {
                    showError(input, `Il campo ${input.previousElementSibling.textContent.replace(':', '')} è obbligatorio`);
                }
                isValid = false;
            } else {
                switch (input.id) {
                    case 'telefono':
                        if (value && !/^[0-9]{6,15}$/.test(value)) {
                            if (showErrors) {
                                showError(input, 'Il numero di telefono deve contenere solo numeri (da 6 a 15 cifre)');
                            }
                            isValid = false;
                        }
                        break;
                    case 'email':
                        if (value && !emailValidator.validateSyntax(value)) {
                            if (showErrors) {
                                showError(input, 'Formato email non valido');
                            }
                            isValid = false;
                        } else if (!value && input.hasAttribute('required')) {
                            if (showErrors) {
                                showError(input, "L'email è obbligatoria");
                            }
                            isValid = false;
                        }
                        break;
                }
            }

            if (isValid) {
                hideError(input);
            }

            return isValid;
        }

        function validateISBN(input) {
            const value = input.value.trim();
            const errorElement = input.parentElement.querySelector('.error-message');

            hideError(input);

            if (!input.matches(':focus') && value.length > 0) {
                if (!/^(?:\d{10}|\d{13})$/.test(value)) {
                    showError(input, 'ISBN deve essere di 10 o 13 cifre');
                    if (errorElement) {
                        errorElement.classList.remove('text-gray-500');
                        errorElement.classList.add('text-red-500');
                    }
                    return false;
                }

                if (value.length === 13 && !value.startsWith('978') && !value.startsWith('979')) {
                    showError(input, 'ISBN-13 deve iniziare con 978 o 979');
                    if (errorElement) {
                        errorElement.classList.remove('text-gray-500');
                        errorElement.classList.add('text-red-500');
                    }
                    return false;
                }
            }

            return true;
        }

        function handleISBNInput(input) {
            input.value = input.value.replace(/\D/g, '');

            if (input.value.length > 13) {
                input.value = input.value.slice(0, 13);
            }

            const errorElement = input.parentElement.querySelector('.error-message');
            if (errorElement && !errorElement.classList.contains('hidden')) {
                errorElement.classList.remove('text-gray-500');
                errorElement.classList.add('text-red-500');
            }

            validateISBN(input);
        }

        function validateBookField(input, showErrors = true) {
            const value = input.value.trim();
            let isValid = true;

            if (input.matches(':focus')) {
                hideError(input);
                return true;
            }

            if (input.hasAttribute('required') && !value) {
                if (showErrors) {
                    if (input.classList.contains('book-title')) {
                        showError(input, 'Il campo Titolo* è obbligatorio');
                    } else {
                        showError(input, 'Questo campo è obbligatorio');
                    }
                }
                isValid = false;
            } else if (input.classList.contains('book-year')) {
                const currentYear = new Date().getFullYear();
                if (value) {
                    if (value.length !== 4 || !Number.isInteger(Number(value)) || Number(value) < 1900 || Number(value) > currentYear) {
                        if (showErrors) {
                            showError(input, `L'anno deve essere compreso tra 1900 e ${currentYear}`);
                        }
                        isValid = false;
                    }
                }
            } else if (input.classList.contains('book-isbn')) {
                if (value && !/^(?:\d{10}|\d{13})$/.test(value)) {
                    if (showErrors) {
                        showError(input, 'ISBN deve essere di 10 o 13 cifre');
                    }
                    isValid = false;
                }
            }

            if (isValid) {
                hideError(input);
            }

            return isValid;
        }

        function validateCheckbox(checkbox) {
            const errorElement = checkbox.parentElement.nextElementSibling;
            if (!checkbox.checked) {
                checkbox.style.border = '2px solid #ef4444';
                if (errorElement && errorElement.classList.contains('error-message')) {
                    errorElement.classList.remove('hidden');
                    errorElement.textContent = 'Devi accettare i termini e le condizioni';
                }
                return false;
            } else {
                checkbox.style.border = '';
                if (errorElement && errorElement.classList.contains('error-message')) {
                    errorElement.classList.add('hidden');
                }
                return true;
            }
        }

        window.duplicateBook = function(button) {
            const originalEntry = button.closest('.book-entry');
            const newEntry = originalEntry.cloneNode(true);

            bookCount++;

            const counter = newEntry.querySelector('.book-counter');
            if (counter) {
                counter.textContent = bookCount;
            }

            const searchSection = newEntry.querySelector('.mb-5:has(.quick-search)');
            if (searchSection) {
                const searchInput = searchSection.querySelector('.quick-search');
                if (searchInput) {
                    searchInput.value = '';
                }
                const searchResults = searchSection.querySelector('.search-results');
                if (searchResults) {
                    searchResults.classList.add('hidden');
                }
                searchSection.style.display = '';
            }

            const inputs = newEntry.querySelectorAll('input');
            inputs.forEach(input => {
                if (input.classList.contains('book-year') || input.classList.contains('book-isbn')) {
                    input.addEventListener('input', () => validateBookField(input));
                    input.addEventListener('blur', () => validateBookField(input));
                }
            });

            originalEntry.after(newEntry);
            updateBookCounters();
        };

        window.removeBook = function(button) {
            const bookEntry = button.closest('.book-entry');
            if (bookEntry) {
                bookEntry.remove();
                bookCount--;
                updateBookCounters();
            }
        };

        window.resetBookFields = function(button) {
            const bookEntry = button.closest('.book-entry');
            if (bookEntry) {
                const inputs = bookEntry.querySelectorAll('input');
                inputs.forEach(input => {
                    input.value = '';
                    hideError(input);
                });

                const quickSearch = bookEntry.querySelector('.quick-search');
                if (quickSearch) {
                    quickSearch.value = '';
                }

                const searchResults = bookEntry.querySelector('.search-results');
                if (searchResults) {
                    searchResults.classList.add('hidden');
                }
            }
        };

        window.selectBookAndClear = function(element, bookData) {
            selectBook(element, bookData);
            const bookEntry = element.closest('.book-entry');
            const searchInput = bookEntry.querySelector('.quick-search');
            const resultsDiv = bookEntry.querySelector('.search-results');
            
            if (searchInput) searchInput.value = '';
            if (resultsDiv) resultsDiv.classList.add('hidden');
        };

        window.selectBook = function(element, bookData) {
            const bookEntry = element.closest('.book-entry');
            bookEntry.querySelector('.book-title').value = bookData.title;
            bookEntry.querySelector('.book-author').value = bookData.authors;
            bookEntry.querySelector('.book-publisher').value = bookData.publisher;
            bookEntry.querySelector('.book-year').value = bookData.year;
            bookEntry.querySelector('.book-isbn').value = bookData.isbn;
            bookEntry.querySelector('.search-results').classList.add('hidden');

            const quickSearchSection = bookEntry.querySelector('.mb-5:has(.quick-search)');
            if (quickSearchSection) {
                quickSearchSection.style.display = 'none';
            }
        };

        function updateBookCounters() {
            const bookEntries = document.querySelectorAll('.book-entry');
            bookEntries.forEach((entry, index) => {
                entry.querySelector('.book-counter').textContent = index + 1;
            });
        }

        window.createBookEntry = function() {
            const bookDiv = document.createElement('div');
            bookDiv.className = 'book-entry relative bg-gray-50 border border-gray-200 rounded-lg p-5 mb-5';
            bookCount++;

            bookDiv.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <span class="book-counter">${bookCount}</span>
                    <div class="flex gap-2">
                        ${bookCount > 1 ? `
                            <button type="button" class="text-green-500" style="background: none; border: none; cursor: pointer; font-size: 1rem; padding: 0.25rem;" title="Duplica libro" onclick="duplicateBook(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button type="button" class="text-blue-500" style="background: none; border: none; cursor: pointer; font-size: 1rem; padding: 0.25rem;" title="Azzera campi" onclick="resetBookFields(this)">
                                <i class="fas fa-undo"></i>
                            </button>
                            <button type="button" class="text-red-500" style="background: none; border: none; cursor: pointer; font-size: 1rem; padding: 0.25rem;" title="Rimuovi libro" onclick="removeBook(this)">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : `
                            <button type="button" class="text-green-500" style="background: none; border: none; cursor: pointer; font-size: 1rem; padding: 0.25rem;" title="Duplica libro" onclick="duplicateBook(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button type="button" class="text-blue-500" style="background: none; border: none; cursor: pointer; font-size: 1rem; padding: 0.25rem;" title="Azzera campi" onclick="resetBookFields(this)">
                                <i class="fas fa-undo"></i>
                            </button>
                        `}
                    </div>
                </div>

                <div class="mb-5">
                    <div class="flex items-center gap-2 mb-2">
                        <label class="flex items-center gap-2">
                            <i class="fas fa-book-open text-lg text-blue-600"></i>
                            <span class="text-blue-600 font-medium">
                                Search & click <span class="text-gray-500 text-sm font-normal">(opzionale)</span>
                            </span>
                            <span class="group relative" style="cursor: help;">
                                <i class="fas fa-info-circle text-gray-500"></i>
                                <div class="tooltip group-hover-visible">
                                    Cerca, seleziona e... boom! La scheda si completa al volo! Se preferisci, puoi inserire i dati manualmente.
                                </div>
                            </span>
                        </label>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" class="quick-search w-full px-3 py-2 border-2 border-gray-300 rounded-l text-base" placeholder="Cerca per titolo, autore o ISBN...">
                        <button type="button" class="search-btn px-4 rounded-r text-white" style="background-color: #3b82f6; border: none; cursor: pointer; transition: background-color 0.3s;">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <div class="search-results hidden mt-2 bg-white border border-gray-200 rounded-lg" style="max-height: 15rem; overflow-y: auto; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);"></div>
                </div>

                <div class="mb-5">
                    <label class="block mb-1 text-slate-700 font-medium">Titolo<span class="required-asterisk">*</span></label>
                    <input type="text" class="book-title w-full px-3 py-2 border-2 border-gray-300 rounded text-base" required>
                    <p class="hidden error-message text-sm text-red-500 mt-1">Il titolo è obbligatorio</p>
                </div>

                <div class="mb-5">
                    <label class="block mb-1 text-slate-700 font-medium">Autore</label>
                    <input type="text" class="book-author w-full px-3 py-2 border-2 border-gray-300 rounded text-base">
                </div>

                <div class="mb-5">
                    <label class="block mb-1 text-slate-700 font-medium">Editore</label>
                    <input type="text" class="book-publisher w-full px-3 py-2 border-2 border-gray-300 rounded text-base">
                </div>

                <div class="mb-5">
                    <label class="block mb-1 text-slate-700 font-medium">Anno</label>
                    <input type="number" min="1400" max="2024" class="book-year w-full px-3 py-2 border-2 border-gray-300 rounded text-base">
                    <p class="hidden error-message text-sm text-red-500 mt-1">Anno non valido</p>
                </div>

                <div class="mb-5">
                    <div class="flex items-center gap-1">
                        <label class="block text-slate-700 font-medium">ISBN <span class="text-gray-500 font-normal">(raccomandato)</span></label>
                        <div class="relative group" style="margin-top: -4px;">
                            <i class="fa-solid fa-circle-info text-gray-500 text-sm" style="cursor: help;"></i>
                            <div class="tooltip group-hover-visible" style="width: 16rem; bottom: 100%; top: auto; margin-bottom: 0.5rem;">
                                Lo trovi sul retro del libro sopra al codice a barre o nella pagina del copyright.
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <input type="tel" inputmode="numeric" class="book-isbn w-full px-3 py-2 border-2 border-gray-300 rounded text-base" maxlength="13" placeholder="Inserisci un numero di 10 o 13 cifre senza trattini">
                        <button type="button" class="scan-isbn-btn px-4 py-2 rounded text-white flex items-center gap-2" style="background-color: #22c55e; border: none; cursor: pointer; transition: background-color 0.3s;" title="Scansiona codice a barre">
                            <i class="fas fa-barcode"></i>
                            <span class="hidden sm:inline">Scansiona</span>
                        </button>
                    </div>
                    <p class="hidden error-message text-sm text-red-500 mt-1">ISBN non valido</p>
                    
                    <div class="isbn-scanner-modal hidden" style="position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.75); z-index: 50; display: flex; align-items: center; justify-content: center; padding: 1rem;">
                        <div class="bg-white rounded-lg p-6" style="max-width: 28rem; width: 100%;">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-slate-700">Scansiona il codice a barre</h3>
                                <button type="button" class="close-scanner text-gray-500" style="background: none; border: none; font-size: 2rem; line-height: 1; cursor: pointer; padding: 0;">&times;</button>
                            </div>
                            <div class="isbn-scanner-reader w-full"></div>
                            <p class="text-sm text-gray-600 mt-3" style="text-align: center;">Posiziona il codice a barre del libro davanti alla fotocamera</p>
                        </div>
                    </div>
                </div>

                <button type="button" class="add-book-btn" onclick="createBookEntry()">+ Aggiungi Libro</button>
            `;

            // Search functionality
            const searchInput = bookDiv.querySelector('.quick-search');
            const searchBtn = bookDiv.querySelector('.search-btn');
            const resultsDiv = bookDiv.querySelector('.search-results');
            let debounceTimer;
            let selectedIndex = -1;
            let searchResults = [];

            const highlightResult = (index) => {
                resultsDiv.querySelectorAll('.search-result').forEach(result => {
                    result.classList.remove('bg-gray-100');
                    result.setAttribute('aria-selected', 'false');
                });

                if (index >= 0 && index < searchResults.length) {
                    const resultElement = resultsDiv.querySelectorAll('.search-result')[index];
                    resultElement.classList.add('bg-gray-100');
                    resultElement.setAttribute('aria-selected', 'true');
                    resultElement.scrollIntoView({ block: 'nearest' });
                }
            };

            const clearSearchState = () => {
                searchInput.value = '';
                resultsDiv.classList.add('hidden');
                selectedIndex = -1;
                searchResults = [];
            };

            const performSearch = async () => {
                const query = searchInput.value.trim();
                if (!query) {
                    resultsDiv.classList.add('hidden');
                    selectedIndex = -1;
                    searchResults = [];
                    return;
                }

                try {
                    const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&key=${config.googleBooks.apiKey}&maxResults=5`);
                    const data = await response.json();

                    if (data.items && data.items.length > 0) {
                        searchResults = data.items;
                        resultsDiv.innerHTML = searchResults.map((book, index) => {
                            const info = book.volumeInfo;
                            const bookData = {
                                title: info.title || '',
                                authors: info.authors ? info.authors.join(', ') : '',
                                publisher: info.publisher || '',
                                year: info.publishedDate ? info.publishedDate.substring(0, 4) : '',
                                isbn: info.industryIdentifiers ? info.industryIdentifiers.find(id => id.type === 'ISBN_13')?.identifier || info.industryIdentifiers.find(id => id.type === 'ISBN_10')?.identifier || '' : ''
                            };

                            return `
                                <div class="search-result" role="option" aria-selected="false" tabindex="-1" data-index="${index}" onclick="selectBookAndClear(this, ${JSON.stringify(bookData).replace(/"/g, '&quot;')})">
                                    <div class="font-medium text-blue-600">${info.title || 'Titolo sconosciuto'}</div>
                                    <div class="text-sm text-gray-600">
                                        ${info.authors ? info.authors.join(', ') : 'Autore sconosciuto'}
                                        ${info.publishedDate ? `(${info.publishedDate.substring(0, 4)})` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('');
                        resultsDiv.classList.remove('hidden');
                        selectedIndex = -1;
                        resultsDiv.setAttribute('role', 'listbox');
                        resultsDiv.setAttribute('aria-label', 'Risultati ricerca libri');
                    } else {
                        resultsDiv.innerHTML = '<div class="p-3 text-gray-600">Nessun risultato trovato</div>';
                        resultsDiv.classList.remove('hidden');
                        searchResults = [];
                        selectedIndex = -1;
                    }
                } catch (error) {
                    console.error('Error searching Google Books:', error);
                    resultsDiv.innerHTML = '<div class="p-3 text-red-600">Errore durante la ricerca</div>';
                    resultsDiv.classList.remove('hidden');
                    searchResults = [];
                    selectedIndex = -1;
                }
            };

            const handleKeyNavigation = (e) => {
                if (!searchResults.length || resultsDiv.classList.contains('hidden')) {
                    return;
                }

                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        selectedIndex = Math.min(selectedIndex + 1, searchResults.length - 1);
                        highlightResult(selectedIndex);
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        selectedIndex = Math.max(selectedIndex - 1, 0);
                        highlightResult(selectedIndex);
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (selectedIndex >= 0 && selectedIndex < searchResults.length) {
                            const selectedResult = resultsDiv.querySelectorAll('.search-result')[selectedIndex];
                            selectedResult.click();
                        }
                        break;
                    case 'Escape':
                        e.preventDefault();
                        clearSearchState();
                        searchInput.blur();
                        break;
                }
            };

            searchInput.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(performSearch, 600);
            });

            searchInput.addEventListener('keydown', handleKeyNavigation);
            searchBtn.addEventListener('click', performSearch);

            document.addEventListener('click', (e) => {
                if (!resultsDiv.contains(e.target) && e.target !== searchInput) {
                    resultsDiv.classList.add('hidden');
                    selectedIndex = -1;
                }
            });

            // ISBN Scanner functionality
            const scanBtn = bookDiv.querySelector('.scan-isbn-btn');
            const scannerModal = bookDiv.querySelector('.isbn-scanner-modal');
            const closeScanner = bookDiv.querySelector('.close-scanner');
            const isbnInput = bookDiv.querySelector('.book-isbn');
            const scannerReader = bookDiv.querySelector('.isbn-scanner-reader');

            const scannerId = 'isbn-scanner-' + bookCount;
            scannerReader.id = scannerId;
            let isScanning = false;

            scanBtn.addEventListener('click', async () => {
                if (isScanning) return;

                scannerModal.classList.remove('hidden');
                isScanning = true;

                setTimeout(() => {
                    Quagga.init({
                        inputStream: {
                            name: "Live",
                            type: "LiveStream",
                            target: `#${scannerId}`,
                            constraints: {
                                width: { min: 640 },
                                height: { min: 480 },
                                facingMode: "environment",
                                aspectRatio: { min: 1, max: 2 }
                            },
                        },
                        locator: {
                            patchSize: "medium",
                            halfSample: true
                        },
                        numOfWorkers: 2,
                        frequency: 10,
                        decoder: {
                            readers: [
                                "ean_reader",
                                "ean_8_reader",
                                "code_128_reader",
                                "code_39_reader",
                                "upc_reader",
                                "upc_e_reader"
                            ]
                        },
                        locate: true
                    }, function(err) {
                        if (err) {
                            console.error("Error initializing Quagga:", err);
                            alert("Impossibile avviare la fotocamera. Assicurati di aver dato i permessi necessari.");
                            stopScanner();
                            return;
                        }
                        Quagga.start();
                    });

                    Quagga.onDetected(function(result) {
                        if (result && result.codeResult && result.codeResult.code) {
                            const code = result.codeResult.code;
                            const numbers = code.replace(/\D/g, '');

                            if (numbers.length === 10 || numbers.length === 13) {
                                scannerReader.style.border = "3px solid #22c55e";

                                const beep = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGGS57OihUBELTKXh8bllHgU2jdXty3MpBSl+zPLaizsIFmm98OypWBQLSKLf8sFuJAUufMzy2Ik2CBhku+zooVARC0yl4fG5ZR4FN43V7ct0KQUpfszy2os7CBVpvfDtqVkUC0ii3/LBbiQFL3zM8tiJNggYZLvs6KFQEQtMpeHxuWUeBTaN1e3LdCkFKX7M8tqLOwgVab3w7alZFAtIot/ywW4kBS98zPLYiTYIGGS77OihUBELTKXh8bllHgU2jdXty3QpBSl+zPLaizsIFWm98O2pWRQLSKLf8sFuJAUvfMzy2Ik2CBhku+zooVARC0yl4fG5ZR4FNo3V7ct0KQUpfszy2os7CBVpvfDtqVkUC0ii3/LBbiQFL3zM8tiJNggYZLvs6KFQEQtMpeHxuWUeBTaN1e3LdCkFKX7M8tqLOwgVab3w7alZFAtIot/ywW4kBS98zPLYiTYIGGS77OihUBELTKXh8bllHgU2jdXty3QpBSl+zPLaizsIFWm98O2pWRQLSKLf8sFuJAUvfMzy2Ik2CBhku+zoo==');
                                beep.play().catch(e => console.log('Audio play failed:', e));

                                setTimeout(() => {
                                    isbnInput.value = numbers;
                                    validateISBN(isbnInput);
                                    stopScanner();
                                }, 500);
                            }
                        }
                    });
                }, 100);
            });

            const stopScanner = () => {
                if (isScanning) {
                    Quagga.stop();
                    isScanning = false;
                }
                scannerModal.classList.add('hidden');
                scannerReader.style.border = "";
            };

            closeScanner.addEventListener('click', stopScanner);

            scannerModal.addEventListener('click', (e) => {
                if (e.target === scannerModal) {
                    stopScanner();
                }
            });

            // Add hover effect for search button
            searchBtn.addEventListener('mouseenter', () => {
                searchBtn.style.backgroundColor = '#2563eb';
            });
            searchBtn.addEventListener('mouseleave', () => {
                searchBtn.style.backgroundColor = '#3b82f6';
            });

            // Add hover effect for scan button
            scanBtn.addEventListener('mouseenter', () => {
                scanBtn.style.backgroundColor = '#16a34a';
            });
            scanBtn.addEventListener('mouseleave', () => {
                scanBtn.style.backgroundColor = '#22c55e';
            });

            // Add validation event listeners
            const inputs = bookDiv.querySelectorAll('input');
            inputs.forEach(input => {
                if (input.classList.contains('book-year') || input.classList.contains('book-isbn')) {
                    input.addEventListener('input', () => validateBookField(input));
                    input.addEventListener('blur', () => validateBookField(input));
                }
            });

            document.getElementById('bookList').appendChild(bookDiv);
            updateBookCounters();
        };

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            createBookEntry();

            const emailInput = document.getElementById('email');
            if (emailInput) {
                emailInput.addEventListener('focus', function() {
                    hideError(this);
                });

                emailInput.addEventListener('blur', function() {
                    validateField(this);
                });

                emailInput.addEventListener('input', function() {
                    if (!this.matches(':focus')) {
                        validateField(this);
                    }
                });
            }

            const inputs = document.querySelectorAll('input');
            inputs.forEach(input => {
                if (input.id) {
                    input.addEventListener('input', () => validateField(input));
                    input.addEventListener('blur', () => validateField(input));
                }
            });

            document.getElementById('accept').addEventListener('change', function() {
                validateCheckbox(this);
            });

            // Character counter for notes
            const textarea = document.getElementById('notes');
            const charCount = document.getElementById('charCount');
            const maxLength = textarea.getAttribute('maxlength');
            let manualHeight = null;

            const autoResize = () => {
                if (manualHeight) {
                    textarea.style.height = `${Math.max(manualHeight, textarea.scrollHeight)}px`;
                } else {
                    textarea.style.height = 'auto';
                    textarea.style.height = `${Math.max(75, textarea.scrollHeight)}px`;
                }
            };

            const updateCharCount = () => {
                const remaining = maxLength - textarea.value.length;
                if (textarea.value.length > 0) {
                    charCount.textContent = `${remaining} caratteri rimanenti`;
                    if (remaining <= 50) {
                        charCount.classList.remove('text-gray-500');
                        charCount.style.color = '#d97706';
                    } else {
                        charCount.style.color = '#6b7280';
                        charCount.classList.add('text-gray-500');
                    }
                    charCount.style.display = 'block';
                } else {
                    charCount.style.display = 'none';
                }
            };

            textarea.addEventListener('mouseup', () => {
                manualHeight = textarea.offsetHeight;
            });

            textarea.addEventListener('input', () => {
                updateCharCount();
                if (textarea.scrollHeight > manualHeight) {
                    autoResize();
                }
            });

            charCount.style.display = 'none';

            if (textarea.value.length > 0) {
                autoResize();
                updateCharCount();
            }
        });

        // Form submission
        document.getElementById('donationForm').addEventListener('submit', async (event) => {
            event.preventDefault();

            if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') {
                return;
            }

            let isValid = true;

            const requiredFields = event.target.querySelectorAll('[required]');
            requiredFields.forEach(field => {
                if (!validateField(field, true)) {
                    isValid = false;
                }
            });

            const bookEntries = document.querySelectorAll('.book-entry');
            bookEntries.forEach(entry => {
                const inputs = entry.querySelectorAll('input');
                inputs.forEach(input => {
                    if (!validateBookField(input, true)) {
                        isValid = false;
                    }
                });
            });

            const acceptCheckbox = document.getElementById('accept');
            if (!validateCheckbox(acceptCheckbox)) {
                isValid = false;
            }

            if (!isValid) {
                showGlobalErrorPopup('Per favore, compila correttamente tutti i campi obbligatori.');
                return;
            }

            const nome = document.getElementById('nome').value.trim();
            const cognome = document.getElementById('cognome').value.trim();
            const email = document.getElementById('email').value.trim();
            const tessera = document.getElementById('tessera').value.trim();
            const telefono = document.getElementById('telefono').value.trim();

            const books = [];
            bookEntries.forEach(entry => {
                const book = {
                    title: entry.querySelector('.book-title').value.trim() || 'Non specificato',
                    author: entry.querySelector('.book-author').value.trim() || 'Non specificato',
                    publisher: entry.querySelector('.book-publisher').value.trim() || 'Non specificato',
                    year: entry.querySelector('.book-year').value.trim() || 'Non specificato',
                    isbn: entry.querySelector('.book-isbn').value.trim() || 'Non specificato'
                };
                books.push(book);
            });

            const formattedBooks = books.map((book, index) => `<tr>
                <td>${index + 1}</td>
                <td>${book.title}</td>
                <td>${book.author}</td>
                <td>${book.publisher}</td>
                <td>${book.year}</td>
                <td>${book.isbn}</td>
            </tr>`).join('');

            showLoadingOverlay();

            try {
                const response = await emailjs.send(
                    config.emailjs.serviceId,
                    config.emailjs.templateId,
                    {
                        to_email: config.library.email,
                        from_name: `${nome} ${cognome}`,
                        from_email: email,
                        reply_to: email,
                        tessera: tessera || 'Non specificata',
                        telefono: telefono || 'Non specificato',
                        books_table: formattedBooks,
                        notes: document.getElementById('notes').value.trim() || 'Nessuna nota aggiuntiva'
                    },
                    config.emailjs.publicKey
                );

                removeLoadingOverlay();
                showSuccessPopup('La tua donazione è stata inviata con successo!');

                event.target.reset();
                document.getElementById('bookList').innerHTML = '';
                bookCount = 0;
                createBookEntry();

                const errorMessages = document.querySelectorAll('.error-message');
                errorMessages.forEach(msg => {
                    msg.classList.add('hidden');
                });
            } catch (error) {
                console.error('Error:', error);
                removeLoadingOverlay();
                showGlobalErrorPopup("Si è verificato un errore durante l'invio. Riprova più tardi.");
            }
        });

        // Event delegation for dynamically created elements
        document.addEventListener('blur', function(e) {
            if (e.target.classList.contains('book-isbn')) {
                validateISBN(e.target);
            }
            if (e.target.classList.contains('book-year')) {
                validateBookField(e.target);
            }
        }, true);

        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('book-isbn')) {
                handleISBNInput(e.target);
            }
        }, true);

        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('book-year')) {
                hideError(e.target);
            }
            if (e.target.classList.contains('book-isbn')) {
                e.target.addEventListener('input', function() {
                    handleISBNInput(this);
                });
                e.target.addEventListener('blur', function() {
                    handleISBNInput(this);
                });
                e.target.addEventListener('focus', function() {
                    handleISBNInput(this);
                    if (this.value.length > 0 && this.value.length !== 10 && this.value.length !== 13) {
                        const errorElement = this.nextElementSibling;
                        if (errorElement && errorElement.classList.contains('error-message')) {
                            errorElement.textContent = 'ISBN deve essere di 10 o 13 cifre';
                            errorElement.classList.remove('hidden', 'text-red-500');
                            errorElement.style.color = '#6b7280';
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>
